@page "/commands"
@using Server.Reawakened.XMLs.Data.Commands
@using Web.Razor.Pages
@model CommandsModel

@{
    ViewData["Title"] = "Commands";
}

@section Scripts {
    <script>
        (function(){
            function findLocalToggle(el){
                const id = el.id;
                return $(el).siblings('.options-toggle[data-target="#'+id+'"]').first();
            }
            $(document).on('show.bs.collapse', '.options-collapse', function(){
                const $btn = findLocalToggle(this);
                if($btn.length){
                    $btn.addClass('open').attr('aria-expanded','true').find('.options-toggle-label').text('Hide Options');
                    $btn.find('.options-toggle-icon').text('−');
                }
            });
            $(document).on('hide.bs.collapse', '.options-collapse', function(){
                const $btn = findLocalToggle(this);
                if($btn.length){
                    $btn.removeClass('open').attr('aria-expanded','false').find('.options-toggle-label').text('Show Options');
                    $btn.find('.options-toggle-icon').text('+');
                }
            });
        })();
    </script>
}

<section class="mq-container mt-space fade-in">
    @await Html.PartialAsync("_PanelShell", new Web.Razor.Pages.Shared.PanelShellModel { Title = (string)ViewData["ServerName"] + " Command Reference", Description = "Note: Some commands may not be fully implemented or may not work on older versions.", CenterHeader = true, AdditionalClasses = "flow panel-p-lg", Reveal = false })
    @functions {
        private static int _optCounter = 0;
        private void RenderParameter(ParameterModel parameter, string parentId)
        {
            var baseId = $"{parentId.Replace("/", "").ToLower()}-{parameter.Name.Replace("/", "").ToLower()}";
            var uniqueSuffix = System.Threading.Interlocked.Increment(ref _optCounter);
            var optionsId = $"{baseId}-{uniqueSuffix}";
            <div class="parameter-nest" style="margin-top:10px;" data-reveal>
                <div>
                    <h5 style="font-size:.75rem; margin:0 0 4px; color:var(--mq-color-accent-soft); letter-spacing:.5px;">
                        @parameter.Name
                        @if (parameter.Optional)
                        {
                            <span class="optional-indicator">(Optional)</span>
                        }
                    </h5>
                    <p style="font-size:.65rem; line-height:1.25; color:var(--mq-color-text-dim); margin:0 0 6px;">@parameter.Description</p>
                    @if (parameter.Options != null && parameter.Options.Any())
                    {
                        <div class="options-collapse collapse" id="@optionsId">
                            <div class="options-list-modern">
                            @foreach (var option in parameter.Options)
                            {
                                <div class="option-item">
                                    <div class="option-line"><span class="option-name">@option.Name</span><span class="option-sep">–</span><span class="option-desc">@option.Description</span></div>
                                    @if (option.Parameters != null && option.Parameters.Any())
                                    {
                                        int parameterId = 0;
                                        foreach (var subParameter in option.Parameters)
                                        {
                                            parameterId++;
                                            RenderParameter(subParameter, $"{optionsId}-{parameterId}");
                                        }
                                    }
                                </div>
                            }
                            </div>
                        </div>
                        <button class="btn-modern btn-pad-sm options-toggle" style="margin-top:6px; font-size:.55rem; letter-spacing:.8px; text-transform:uppercase; display:inline-flex; align-items:center; gap:6px;" data-toggle="collapse" data-target="#@optionsId" aria-expanded="false" aria-controls="@optionsId">
                            <span class="options-toggle-icon" aria-hidden="true">+</span>
                            <span class="options-toggle-label">Show Options</span>
                        </button>
                    }
                </div>
            </div>
        }

        private static bool _firstSectionRendered = false;
        private void RenderCommandList(List<CommandModel> commands, string name)
        {
            var top = _firstSectionRendered ? "1.4rem" : ".85rem"; _firstSectionRendered = true;
            <h2 class="t-sub" style="margin-top:@top;" data-reveal>@name Commands</h2>
            <div class="command-grid mt-2" data-reveal>
                @foreach (var command in commands)
                {
                    <div class="command-card-modern" data-reveal>
                        <div>
                            <h3>@command.CommandName</h3>
                            <p>@command.CommandDescription</p>
                        </div>
                        @if (command.Parameters != null && command.Parameters.Any())
                        {
                            int parameterId = 0;
                            foreach (var parameter in command.Parameters)
                            {
                                parameterId++;
                                RenderParameter(parameter, $"options-{name}-{command.CommandName}-{parameterId}");
                            }
                        }
                        <div class="command-meta @(command.AccessLevel > Server.Base.Accounts.Enums.AccessLevel.Player ? "danger" : null)">
                            <span>Requires @command.AccessLevel</span>
                        </div>
                    </div>
                }
            </div>
        }
    }
    <div class="flow" style="margin-top:.35rem;">
        @if ((Model.ServerCommands == null || !Model.ServerCommands.Any()) && (Model.ClientCommands == null || !Model.ClientCommands.Any()))
        {
            <div class="panel-glass" style="background:rgba(255,255,255,0.02); padding:1.25rem; border-radius:16px; border:1px dashed var(--mq-color-border-accent);">
                <p style="font-size:.75rem; letter-spacing:.4px; color:var(--mq-color-text-dim); margin:0;">No commands are currently loaded. This usually means the server hasn't finished starting or command bundles are still initializing. Refresh in a moment.</p>
            </div>
        }
        else
        {
            RenderCommandList(Model.ServerCommands ?? new List<CommandModel>(), "Server");
            RenderCommandList(Model.ClientCommands ?? new List<CommandModel>(), "Client");
        }
    </div>
</section>